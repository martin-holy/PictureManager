<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:cc="clr-namespace:PictureManager.CustomControls"
                    xmlns:mhc="clr-namespace:MH.UI.WPF.Controls;assembly=MH.UI.WPF"
                    xmlns:rd="clr-namespace:PictureManager.ResourceDictionaries">
  <ResourceDictionary.MergedDictionaries>
    <ResourceDictionary Source="../Converters.xaml" />
  </ResourceDictionary.MergedDictionaries>

  <Style x:Key="CustomControls.VirtualizingWrapPanel" TargetType="{x:Type cc:VirtualizingWrapPanel}">
    <Setter Property="Template">
      <Setter.Value>
        <ControlTemplate TargetType="{x:Type cc:VirtualizingWrapPanel}">
          <ItemsControl x:Name="PART_Grid"
                        ItemsSource="{Binding Rows, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type cc:VirtualizingWrapPanel}}}"
                        VirtualizingStackPanel.IsVirtualizing="True" 
                        VirtualizingPanel.ScrollUnit="Pixel" 
                        VirtualizingPanel.VirtualizationMode="Recycling"
                        ScrollViewer.CanContentScroll="True">
            <ItemsControl.ItemsPanel>
              <ItemsPanelTemplate>
                <VirtualizingStackPanel CacheLengthUnit="Page" CacheLength="2" />
              </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.Resources>
              <!-- Row -->
              <DataTemplate DataType="{x:Type cc:VirtualizingWrapPanelRow}">
                <ItemsControl ItemsSource="{Binding Items}" ItemTemplate="{Binding ItemDataTemplate}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <StackPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                </ItemsControl>
              </DataTemplate>

              <!-- GroupItem -->
              <DataTemplate DataType="{x:Type cc:VirtualizingWrapPanelGroupItem}" x:Key="GroupItemDataTemplate">
                <StackPanel Orientation="Horizontal" ToolTip="{Binding ToolTip}">
                  <mhc:Icon
                    Source="{Binding Icon, Converter={StaticResource ResourceConverter}}"
                    Fill="{Binding Icon,
                            Converter={StaticResource DictionaryConverter},
                            ConverterParameter={x:Static rd:Dictionaries.IconNameToBrush},
                            FallbackValue={StaticResource ColorBrushWhite}}"
                    ShowShadow="False"
                    HorizontalAlignment="Center"
                    Margin="8,8,0,8"/>
                  <TextBlock Text="{Binding Title}" FontSize="20" Padding="8" />
                </StackPanel>
              </DataTemplate>

              <!-- Group -->
              <DataTemplate DataType="{x:Type cc:VirtualizingWrapPanelGroup}">
                <Border BorderBrush="Black" BorderThickness="1" Margin="1,2,0,2" Background="#88000000">
                  <StackPanel Orientation="Horizontal">
                    <ItemsControl ItemsSource="{Binding GroupInfo}" ItemTemplate="{StaticResource GroupItemDataTemplate}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <StackPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                    </ItemsControl>

                    <!-- Group Items Count -->
                    <StackPanel Orientation="Horizontal" Visibility="{Binding ShowGroupItemsCount, Converter={StaticResource AllToVisibilityConverter}, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type cc:VirtualizingWrapPanel}}}">
                      <mhc:Icon
                        Source="{Binding GroupItemsCountIcon, 
                                  RelativeSource={RelativeSource AncestorType={x:Type cc:VirtualizingWrapPanel}},
                                  Converter={StaticResource ResourceConverter}}"
                        Fill="{Binding GroupItemsCountIcon,
                                RelativeSource={RelativeSource AncestorType={x:Type cc:VirtualizingWrapPanel}},
                                Converter={StaticResource DictionaryConverter},
                                ConverterParameter={x:Static rd:Dictionaries.IconNameToBrush},
                                FallbackValue={StaticResource ColorBrushWhite}}"
                        ShowShadow="False"
                        HorizontalAlignment="Center" />
                      <TextBlock Text="{Binding ItemsCount}" FontSize="20" Padding="8" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </DataTemplate>

            </ItemsControl.Resources>

            <ItemsControl.Template>
              <ControlTemplate>
                <cc:WheelSpeedScrollViewer x:Name="PART_RowsScrollViewer" SpeedFactor="{Binding ScrollViewerSpeedFactor, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type cc:VirtualizingWrapPanel}}}">
                  <ItemsPresenter x:Name="PART_ItemsPresenter" />
                </cc:WheelSpeedScrollViewer>
              </ControlTemplate>
            </ItemsControl.Template>

          </ItemsControl>
        </ControlTemplate>
      </Setter.Value>
    </Setter>
  </Style>
</ResourceDictionary>